include common.mk

PVALAC		:=	$(NAME)c
LIBPVALA	:=	lib$(NAME)$(PACKAGE_SUFFIX).so

PVALAC_C_SRC	+=	$(wildcard compiler/*.c)
LIBPVALA_C_SRC	+=	$(wildcard gee/*.c) $(wildcard ccode/*.c)	\
			$(wildcard codegen/*.c) $(wildcard pvala/*.c)
PVALAC_OBJ	+=	$(patsubst %.c,%.o,$(PVALAC_C_SRC))
LIBPVALA_OBJ	+=	$(patsubst %.c,%.o,$(LIBPVALA_C_SRC))

PKGC		+=	$(shell pkg-config --cflags $(PKGS))
PKGL		+=	$(shell pkg-config --libs $(PKGS))

CFLAGS		+=	$(PKGC) -w -O2 -pipe -fPIC -I.
LDFLAGS		+=	$(PKGL)

all: $(PVALAC)

$(LIBPVALA): $(LIBPVALA_OBJ) 
	@echo "[CCLD]	$@"
	@$(CC) -shared -o $@ $(LIBPVALA_OBJ) $(LDFLAGS)

$(PVALAC): $(LIBPVALA) $(PVALAC_OBJ)
	@echo "[CCLD]	$@"
	@$(CC) -o $@ $(PVALAC_OBJ) $(LDFLAGS) -L. -l$(NAME)$(PACKAGE_SUFFIX)

%.o: %.c
	@echo "[CC]	$@"
	@$(CC) -o $@ -c $< $(CFLAGS)

clean:
	@echo "[Clean]"
	@rm -f $(PVALAC) $(LIBPVALA) $(PVALAC_OBJ) $(LIBPVALA_OBJ)

distclean: clean
	@echo "[Distclean]"
	@rm -f $(GENERATED) $(PVALAC_C_SRC) $(LIBPVALA_C_SRC) \
		lib$(NAME)$(PACKAGE_SUFFIX).h lib$(NAME)$(PACKAGE_SUFFIX).vapi

.PHONY: all clean distclean
.PRECIOUS:
